<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>C2 Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="p-4">
  <h1 class="mb-4">Dashboard do Servidor C2</h1>

  <div class="mb-3">
    <label for="agentSelect" class="form-label">Escolha o Agente:</label>
    <select id="agentSelect" class="form-select">
      <option value="">-- Selecione --</option>
      {% for agent_id in agents.keys() %}
      <option value="{{ agent_id }}">{{ agent_id }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="commandInput" class="form-label">Comando:</label>
    <input type="text" id="commandInput" class="form-control" placeholder="Digite o comando" />
  </div>

  <button id="sendCommandBtn" class="btn btn-primary mb-4">Enviar Comando</button>

  <h2>Logs do Agente</h2>
  <pre id="logArea" style="background:#222;color:#eee;padding:1rem; height:300px; overflow:auto;"></pre>

  <script>
    function loadLogs(agent_id) {
      if (!agent_id) {
        $('#logArea').text('');
        return;
      }
      $.get('/get-logs/' + agent_id, function(data) {
        const logs = data.logs.map(log => `[${log[0]}] ${log[1]}`).join('\n');
        $('#logArea').text(logs);
        $('#logArea').scrollTop($('#logArea')[0].scrollHeight);
      });
    }

    $('#agentSelect').on('change', function() {
      loadLogs(this.value);
    });

    $('#sendCommandBtn').on('click', function() {
      const agent_id = $('#agentSelect').val();
      const command = $('#commandInput').val().trim();
      if (!agent_id || !command) {
        alert('Selecione um agente e digite um comando!');
        return;
      }
      $.ajax({
        url: '/send-command/' + agent_id,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({command}),
        success: () => {
          $('#commandInput').val('');
          alert('Comando enviado!');
        },
        error: () => alert('Erro ao enviar comando.')
      });
    });

    setInterval(() => {
      const agent_id = $('#agentSelect').val();
      if (agent_id) loadLogs(agent_id);
    }, 5000);
  </script>
</body>
</html>
